<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Crypto Currency Price</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">
    
</head>

<body>
    <div class="container">
        <div class="row">
            <div>
                <h3 id="title">BTC</h3>
            </div>
            <hr>
            <div>
                   Crypto Currencies: <select id="cryptos">
                    <option value="" selected="selected">Select crypto</option>
                  </select>
                  
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
<script>
    $(document).ready(function () {
        var name_obj = []
        var keys1 = []
        var sel = "k"
        var keys2 = []
        var api = "https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chartdata?crypto_name="


        $.getJSON("https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chart", 
            function (data) {
                
                // $.each(data, function(key,value){
                //     keys2.push(key)
                // })

                keys1 = Object.keys(data)
                console.log(api)
                var cryptoSel = document.getElementById("cryptos");
                keys1.forEach(function(x){
                    cryptoSel.options[cryptoSel.options.length] = new Option(x, x);
                })
                cryptoSel.onchange = function(){
                    sel = this.value
                    console.log(sel)
                    api2 = api + sel
                    console.log(api2)
                    lineChart.destroy()
                    i=0
                    d=[]
                    config.data.labels = []
                    config.data.datasets[0].data = []
                    context = document.getElementById('canvas').getContext('2d');
                    lineChart = new Chart(context, config);

                    $.getJSON(api2, 
                        function (data) {
                            $.each(data.prices.reverse(), function (key, value) {
                                // console.log(value.time.slice(11, 19))
                                config.data.labels.push(value.time.slice(11, 19));
                                config.data.datasets[0].data.push(value.price);
                                lineChart.update();
                                d.push(value)
                                i++
                                if(i>=10){
                                    i=0
                                    console.log(d)
                                    return false
                                }
                                
                        })
                    })
                    document.getElementById('title').innerText = sel



                }

            })
        

        const config = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: "Live Price (â‚¹)",
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: [],
                    fill: false,
                }],
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'Real-Time Crypto Currency Price Chart'
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Value'
                        }
                    }]
                }
            }
        };

        context = document.getElementById('canvas').getContext('2d');

        lineChart = new Chart(context, config);

    //     const source = new EventSource("/chart-data/{{crypto}}");

    //     source.onmessage = function (event) {
    //         const data = JSON.parse(event.data);
    //         if (config.data.labels.length === 20) {
    //             config.data.labels.shift();
    //             config.data.datasets[0].data.shift();
    //         }
    //         config.data.labels.push(data.time);
    //         config.data.datasets[0].data.push(data.value);
    //         lineChart.update();
    //     }
        i=0
        d=[]
        $.getJSON("https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chartdata?crypto_name=BTC", 
            function (data) {
                $.each(data.prices.reverse(), function (key, value) {
                    // console.log(value.time.slice(11, 19))
                    config.data.labels.push(value.time.slice(11, 19));
                    config.data.datasets[0].data.push(value.price);
                    lineChart.update();
                    d.push(value)
                    i++
                    if(i>=10){
                        i=0
                        console.log(d)
                        return false
                    }
                    
             })
        })
        
    });
</script>

</body>
</html>
