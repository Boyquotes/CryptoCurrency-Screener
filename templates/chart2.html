<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Crypto Currency Price</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">
    
</head>

<body>
    <div class="container">
        <div class="row">
            <div>
                <h3 id="title">BITCOIN</h3>
            </div>
            <hr>
            <div>
                   Crypto Currencies: <select id="cryptos">
                    <option value="" selected="selected">Select Crypto Currency</option>
                  </select>
                  
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script>
    $(document).ready(function () {
        var name_obj = []
        var keys1 = []
        var sel = "k"
        var keys2 = []
        var api = "https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chart-data2?crypto_name="


        $.getJSON("https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chart-symbols1", 
            function (data) {

                keys1 = Object.keys(data)
                j=0
                keys2 = Object.values(data)
                console.log(api)
                var cryptoSel = document.getElementById("cryptos");
                keys1.forEach(function(x){
                    cryptoSel.options[cryptoSel.options.length] = new Option(keys2[j], x);
                    j++
                })
                cryptoSel.onchange = function(){
                    sel = this.value
                    sel2 = cryptoSel.options[cryptoSel.selectedIndex].text
                    if (sel2 !== "Select Crypto Currency"){
                    console.log(sel)
                    api2 = api + sel
                    console.log(api2)
                    lineChart.destroy()
                    // clearInterval(set_inv)
                    i=0
                    d=[]
                    p=[]
                    config.data.labels = []
                    config.data.datasets[0].data = []
                    context = document.getElementById('canvas').getContext('2d');
                    lineChart = new Chart(context, config);
                    $.getJSON(api2, 
                        function (data) {
                            $.each(data.prices, function (key, value) {
                                p.push(value.price)
                                d.push(moment(value.time).format("LTS").slice(0,7))
                                i++
                                if(i>=10){
                                    i=0
                                    console.log(d)
                                    config.data.labels = d.reverse()
                                    config.data.datasets[0].data = p
                                    lineChart.update();
                                    return false
                                }
                                
                                
                        })
                    })
                    document.getElementById('title').innerText = sel2.toUpperCase()
                    setInterval(function()
                    {
                        continue_callback2()
                    }, 10000);

                    }

                }

            })
        

        const config = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: "Live Price (â‚¹)",
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: [],
                    fill: false,
                }],
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'Real-Time Crypto Currency Price Chart'
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Value'
                        }
                    }]
                }
            }
        };

        context = document.getElementById('canvas').getContext('2d');

        lineChart = new Chart(context, config);

    //     const source = new EventSource("/chart-data/{{crypto}}");

    //     source.onmessage = function (event) {
    //         const data = JSON.parse(event.data);
    //         if (config.data.labels.length === 20) {
    //             config.data.labels.shift();
    //             config.data.datasets[0].data.shift();
    //         }
    //         config.data.labels.push(data.time);
    //         config.data.datasets[0].data.push(data.value);
    //         lineChart.update();
    //     }
        i=0
        d=[]
        p=[]
        $.getJSON("https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chart-data2?crypto_name=BTC", 
            function (data) {
                $.each(data.prices, function (key, value) {

                    
                    p.push(value.price)
                    d.push(moment(value.time).format("LTS").slice(0,7))
                    i++
                    if(i>=10){
                        i=0
                        console.log(d)
                        console.log(p)
                        config.data.labels = d.reverse()
                        config.data.datasets[0].data = p
                        lineChart.update();
                        return false
                    }
                    
             })
        })

        // var set_inv = setInterval(function()
        //             {
        //                 continue_callback()
        //             }, 10000);
        
        
    

    function continue_callback(){
        console.log("k")
        $.getJSON("https://cors.bridged.cc/https://yahoo-crypto-api.herokuapp.com/chart-data2?crypto_name=BTC", 
            function (data) {
                t = data.prices[0].time.slice(11, 19)
                v = data.prices[0].price
                if (d[d.length-1] !== t){
                    config.data.labels.shift();
                    config.data.datasets[0].data.shift();
                    config.data.labels.push(t);
                    config.data.datasets[0].data.push(v);
                    lineChart.update();
                    p.push(v)
                    d.push(t)
                    console.log(d)
                    console.log(p)
                    
                }

                    
                    
             
        })

    }

    function continue_callback2(){
        console.log("h")
    }

});

</script>

</body>
</html>
